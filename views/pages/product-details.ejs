<style>
    .product-detail-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 2rem;
        background: var(--background);
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    h1,
    h2,
    h3,
    p {
        margin: 0 0 1rem 0;
    }

    /* ========================
       Produit (Header, images, infos)
    ============================= */
    .product-header {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        gap: 2rem;
        margin-bottom: 2rem;
        justify-content: center;
    }

    .product-images-container {
        display: flex;
        flex-direction: row;
        justify-content: center;
    }

    .product-images {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        max-height: 400px;
        overflow-y: auto;
        justify-content: space-evenly;

    }

    .product-images .thumbnail {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border: 2px solid transparent;
        border-radius: 4px;
        cursor: pointer;
        transition: border-color 0.3s ease;
    }

    .product-images .thumbnail.active {
        border-color: #ff6f61;
    }

    .product-image {
        width: 500px;
        height: 500px;
        border-radius: 8px;
        object-fit: cover;
    }

    .product-infos {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        padding: 1.5rem;
        background: rgba(255, 111, 97, 0.05);
        border-radius: 8px;
        border-left: 4px solid #ff6f61;
        max-width: 400px;
        width: 100%;
    }

    .product-infos label {
        display: block;
        font-weight: 600;
        color: var(--text);
        margin-bottom: 0.5rem;
    }

    .product-infos select,
    .product-infos input[type="number"] {
        width: 100%;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 1rem;
        background: white;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    .product-infos select:focus,
    .product-infos input[type="number"]:focus {
        outline: none;
        border-color: #ff6f61;
        box-shadow: 0 0 0 3px rgba(255, 111, 97, 0.1);
    }

    .product-infos .form-group {
        margin-bottom: 1rem;
    }

    .product-quantity {
        font-size: 1rem;
        color: #666;
        padding: 0.5rem 0;
        border-top: 1px solid #eee;
        border-bottom: 1px solid #eee;
    }

    .add-to-cart {
        width: 100% !important;
        padding: 1rem !important;
        font-size: 1.1rem !important;
        margin-top: 1rem !important;
        transition: transform 0.2s ease, background-color 0.3s !important;
        display: flex !important;
        justify-content: center !important;
        gap: 0.8rem !important;
        border-radius: 6px !important;
    }

    .add-to-cart:hover {
        transform: translateY(-2px) !important;
        background-color: #e55a4d !important;
    }

    .product-price {
        font-size: 2rem;
        color: #ff6f61;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .product-price::before {
        content: "€";
        font-size: 1.2rem;
        color: currentColor;
    }

    /* ========================
Section Avis / Reviews
============================= */
    .reviews-section {
        margin-top: 2rem;
    }

    .reviews-section h2 {
        font-size: 1.8rem;
        border-bottom: 2px solid #ff6f61;
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .reviews-list {
        margin-bottom: 2rem;
        padding: 1rem;
        background: var(--background);
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .review {
        border-bottom: 1px solid #ddd;
        padding: 1rem 0;
    }

    .review:last-child {
        border-bottom: none;
    }

    .review-author {
        font-weight: bold;
        margin-bottom: 0.3rem;
    }

    .review-rating-display {
        margin-bottom: 0.5rem;
    }

    .review-content {
        font-style: italic;
        color: var(--text);
        margin-bottom: 0.5rem;
    }

    .review-date {
        font-size: 0.875rem;
        color: #999;
    }

    .review-actions button,
    .report-review {
        margin-right: 0.5rem;
        padding: 0.3rem 0.6rem;
        font-size: 0.9rem;
        background-color: #ff6f61;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .review-actions button:hover,
    .report-review:hover:not([disabled]) {
        background-color: #e55a4d;
    }

    .report-review[disabled] {
        background-color: #ccc;
        cursor: default;
    }

    .edit-review-form input.edit-review-text {
        width: 100%;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 4px;
    }

    .edit-review-form button {
        margin-right: 0.5rem;
        padding: 0.3rem 0.6rem;
        font-size: 0.9rem;
        background-color: #ff6f61;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .edit-review-form button:hover {
        background-color: #e55a4d;
    }

    /* ========================
Formulaire d'avis
============================= */
    .review-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .review-form textarea {
        width: 100%;
        padding: 0.75rem;
        font-size: 1rem;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: vertical;
    }

    .review-form button {
        align-self: flex-start;
        padding: 0.5rem 1rem;
        font-size: 1rem;
        background-color: #ff6f61;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .review-form button:hover {
        background-color: #e55a4d;
    }

    /* ========================
Sélecteur d'étoiles (Star Rating)
Application aux conteneurs interactifs et en lecture seule
============================= */
    .star-rating,
    .star-rating-readonly {
        display: inline-block;
    }

    .star-rating .star,
    .star-rating-readonly .star {
        font-size: 2.5rem;
        cursor: pointer;
        color: #e0e0e0;
        transition: color 0.2s ease, transform 0.2s ease;
        text-shadow: 0 1px 1px rgba(0, 0, 0, 0.2);
    }

    .star-rating .star.full,
    .star-rating-readonly .star.full {
        color: #ffcc00;
        transform: scale(1.1);
    }

    .star-rating .star.half,
    .star-rating-readonly .star.half {
        background: linear-gradient(90deg, #ffcc00 50%, #e0e0e0 50%);
        -webkit-background-clip: text;
        color: transparent;
    }

    .star-rating-readonly .star {
        cursor: default;
    }

    /* ========================
Responsive Design
============================= */
    @media screen and (max-width: 768px) {
        .product-header {
            flex-direction: column;
            align-items: center;
            flex-wrap: wrap;
        }

        .product-images-container {
            flex-direction: column;
        }

        .product-image {
            width: 100%;
            height: auto;
        }

        .product-images {
            flex-direction: row;
            gap: 0.5rem;
            max-height: auto;
            overflow-x: auto;
        }

        .product-images .thumbnail {
            width: 50px;
            height: 50px;
        }

        .product-infos {
            max-width: 100%;
            border-left: none;
            border-top: 4px solid #ff6f61;
            padding: 1rem;
        }

        .product-price {
            font-size: 1.75rem;
            justify-content: center;
        }

        .add-to-cart {
            padding: 0.85rem !important;
            font-size: 1rem !important;
            margin-top: 0.5rem !important;
        }

        .product-infos select,
        .product-infos input[type="number"] {
            font-size: 0.9rem;
        }
    }
</style>

<!-- ========================
       Contenu Produit
  ============================= -->
<div class="product-header">
    <div class="product-images-container">
        <div class="product-images">
            <% product.content.url.forEach((imageId, index)=> { %>
                <img class="thumbnail <%= index === 0 ? 'active' : '' %>"
                    src="<%= API_URL %>/api/v1/images?product_id=<%= product.content.id %>&image_id=<%= imageId %>"
                    alt="<%= product.content.name %>" data-index="<%= index %>" />
                <% }); %>
        </div>
        <img class="product-image"
            src="<%= API_URL %>/api/v1/images?product_id=<%= product.content.id %>&image_id=<%= product.content.url[0] %>"
            alt="<%= product.content.name %>" id="main-image" />
    </div>

    <div class="product-infos">
        <h1 class="product-name">
            <%= product.content.name %>
        </h1>
        <p class="product-description">
            <%= product.content.description %>
        </p>
        <p class="product-price">
            <%= product.content.price.toFixed(2) %>€
        </p>
        <p class="product-quantity">
            Quantité disponible : <span id="product-quantity-display">
                <%= product.content.inventory %>
            </span>
        </p>
        <% if (logged) { %>
            <% if (product.content.colors && product.content.colors.length> 0) { %>
                <label for="product-color">Couleur :</label>
                <select id="product-color">
                    <% product.content.colors.forEach(color=> { %>
                        <option value="<%= color %>">
                            <%= color %>
                        </option>
                        <% }); %>
                </select>
                <% } %>

                    <% if (product.content.sizes && product.content.sizes.length> 0) { %>
                        <label for="product-size">Taille :</label>
                        <select id="product-size">
                            <% product.content.sizes.forEach(size=> { %>
                                <option value="<%= size %>">
                                    <%= size %>
                                </option>
                                <% }); %>
                        </select>
                        <% } %>

                            <label for="product-quantity">Quantité :</label>
                            <input type="number" id="product-quantity" name="quantity" value="1" min="1"
                                max="<%= product.content.inventory %>" />

                            <button class="add-to-cart" id="product_<%= product.content.id %>"
                                data-product-id="<%= product.content.id %>"
                                data-product-price="<%= product.content.price %>">
                                <ion-icon name="cart-outline"></ion-icon>
                                Ajouter au panier
                            </button>
                            <% } %>
    </div>

</div>

<!-- ========================
       Section Reviews
  ============================= -->
<div class="reviews-section">
    <h2>Laisser un avis</h2>
    <% if (logged) { %>
        <form class="review-form" action="/api/v1/reviews" method="POST">
            <textarea name="review" id="review" placeholder="Écrivez votre avis ici..." required></textarea>
            <!-- Sélecteur d'étoiles interactif pour la note -->
            <div id="star-rating" class="star-rating">
                <span class="star" data-index="0">&#9733;</span>
                <span class="star" data-index="1">&#9733;</span>
                <span class="star" data-index="2">&#9733;</span>
                <span class="star" data-index="3">&#9733;</span>
                <span class="star" data-index="4">&#9733;</span>
            </div>
            <input type="hidden" name="rating" id="review-rating" value="0">
            <input type="hidden" name="product_id" id="product_id" value="<%= product.content.id %>">
            <button type="submit" class="submit-review">Envoyer</button>
        </form>
        <% } else { %>
            <p>Veuillez vous connecter pour laisser un avis.</p>
            <% } %>

                <br>
                <h2>Avis des utilisateurs</h2>
                <div class="reviews-list">
                    <% if (reviews.status===200) { %>
                        <% reviews.content.forEach(review=> { %>
                            <div class="review" data-review-id="<%= review.id %>">
                                <p class="review-author">Par <%= review.username %>:</p>
                                <!-- Affichage de la note au-dessus du commentaire -->
                                <div class="review-rating-display star-rating-readonly"
                                    data-rating="<%= review.rating %>"></div>
                                <% if (logged && profile && review.user_id===profile.id) { %>
                                    <p class="review-content" data-review-text>
                                        <%= review.review %>
                                    </p>
                                    <div class="review-actions">
                                        <button class="edit-review">Modifier</button>
                                        <button class="delete-review">Supprimer</button>
                                    </div>
                                    <div class="edit-review-form" style="display: none;">
                                        <input type="text" class="edit-review-text" value="<%= review.review %>" />
                                        <div class="edit-star-rating star-rating">
                                            <span class="star" data-index="0">&#9733;</span>
                                            <span class="star" data-index="1">&#9733;</span>
                                            <span class="star" data-index="2">&#9733;</span>
                                            <span class="star" data-index="3">&#9733;</span>
                                            <span class="star" data-index="4">&#9733;</span>
                                        </div>
                                        <input type="hidden" class="edit-review-rating" value="<%= review.rating %>">
                                        <button class="save-review">Enregistrer</button>
                                        <button class="cancel-edit">Annuler</button>
                                    </div>
                                    <% } else { %>
                                        <p class="review-content">"<%= review.review %>"</p>
                                        <% } %>
                                            <% if (logged && profile && review.user_id !==profile.id) { %>
                                                <% if (review.reportedByUsers.indexOf(profile.id)===-1) { %>
                                                    <button class="report-review">Signaler</button>
                                                    <% } else { %>
                                                        <button class="report-review" disabled>Déjà signalé</button>
                                                        <% } %>
                                                            <% } %>
                                                                <p class="review-date">
                                                                    <%= new Date(review.createdAt).toLocaleDateString()
                                                                        %>
                                                                </p>
                            </div>
                            <% }); %>
                                <% } else { %>
                                    <p>Aucun avis pour le moment.</p>
                                    <% } %>
                </div>
</div>

<script>
    /*********************
     * Gestion des images
     *********************/
    document.addEventListener('DOMContentLoaded', () => {
        const thumbnails = document.querySelectorAll('.thumbnail');
        const mainImage = document.getElementById('main-image');
        thumbnails.forEach(thumbnail => {
            thumbnail.addEventListener('click', () => {
                thumbnails.forEach(thumb => thumb.classList.remove('active'));
                thumbnail.classList.add('active');
                mainImage.src = thumbnail.src;
            });
        });
    });

    /*********************
     * Fonction de gestion du Star Rating interactif
     *********************/
    function setupStarRating(container, hiddenInput, initialRating = 0) {
        const stars = container.querySelectorAll('.star');
        let currentRating = initialRating;
        updateStars(currentRating);
        function updateStars(rating) {
            stars.forEach((star, index) => {
                const starValue = index + 1;
                if (rating >= starValue) {
                    star.classList.remove('half');
                    star.classList.add('full');
                } else if (rating >= starValue - 0.5) {
                    star.classList.remove('full');
                    star.classList.add('half');
                } else {
                    star.classList.remove('full', 'half');
                }
            });
        }
        stars.forEach((star, index) => {
            star.addEventListener('mousemove', (e) => {
                const rect = star.getBoundingClientRect();
                const offsetX = e.clientX - rect.left;
                const starWidth = rect.width;
                const rating = index + (offsetX < starWidth / 2 ? 0.5 : 1);
                updateStars(rating);
            });
            star.addEventListener('click', (e) => {
                const rect = star.getBoundingClientRect();
                const offsetX = e.clientX - rect.left;
                const starWidth = rect.width;
                currentRating = index + (offsetX < starWidth / 2 ? 0.5 : 1);
                hiddenInput.value = currentRating;
            });
        });
        container.addEventListener('mouseleave', () => {
            updateStars(currentRating);
        });
    }

    /*********************
     * Initialisation du star rating pour le formulaire d'avis
     *********************/
    document.addEventListener('DOMContentLoaded', () => {
        const reviewStarContainer = document.getElementById('star-rating');
        const reviewRatingInput = document.getElementById('review-rating');
        setupStarRating(reviewStarContainer, reviewRatingInput);
    });

    /*********************
     * Génération des étoiles en lecture seule
     *********************/
    function generateReadonlyStars(rating) {
        let html = '';
        for (let i = 0; i < 5; i++) {
            if (rating >= i + 1) {
                html += '<span class="star full">&#9733;</span>';
            } else if (rating >= i + 0.5) {
                html += '<span class="star half">&#9733;</span>';
            } else {
                html += '<span class="star">&#9733;</span>';
            }
        }
        return html;
    }
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('.star-rating-readonly').forEach(container => {
            const rating = parseFloat(container.getAttribute('data-rating'));
            container.innerHTML = generateReadonlyStars(rating);
        });
    });

    /*********************
     * Création d'un avis
     *********************/
    async function createReview_request(review, rating, product_id) {
        const formData = new FormData();
        formData.append('review', review);
        formData.append('rating', rating);
        formData.append('product_id', product_id);
        const response = await fetch(`<%= API_URL %>/api/v1/reviews/create`, {
            method: 'POST',
            credentials: 'include',
            body: formData,
        });
        return await response.json();
    }
    document.addEventListener("DOMContentLoaded", () => {
        const review_form = document.querySelector(".review-form");
        review_form.addEventListener("submit", async event => {
            event.preventDefault();
            const review_content = review_form.querySelector("#review").value;
            const product_id = review_form.querySelector("#product_id").value;
            const rating = review_form.querySelector("#review-rating").value || 0;
            const created_review = await createReview_request(review_content, rating, product_id);
            if (created_review.status === 201) {
                setTimeout(() => window.location.reload(), 200);
            } else {
                showErrorModal(created_review.content || ['Erreur lors de la création de l\'avis']);
            }
        });
    });

    /*********************
     * Modification et suppression d'un avis
     *********************/
    async function modifyReview_request(review, rating, id) {
        const formData = new FormData();
        formData.append('review', review);
        formData.append('rating', rating);
        const response = await fetch(`<%= API_URL %>/api/v1/reviews/modify/${id}`, {
            method: 'PATCH',
            credentials: 'include',
            body: formData,
        });
        return await response.json();
    }
    async function deleteReview_request(id) {
        const response = await fetch(`<%= API_URL %>/api/v1/reviews/delete/${id}`, {
            method: 'DELETE',
            credentials: 'include'
        });
        return await response.json();
    }

    /*********************
     * Report d'un avis
     *********************/
    async function reportReview_request(id) {
        const formData = new FormData();
        const response = await fetch(`<%= API_URL %>/api/v1/reviews/report/${id}`, {
            method: 'POST',
            credentials: 'include',
            body: formData,
        });
        return await response.json();
    }

    /*********************
     * Ajout au panier
     *********************/
    async function addToCart_request(product_id, color, size, quantity) {
        const formData = new FormData();
        formData.append('product_id', product_id);
        formData.append('color', color);
        formData.append('size', size);
        formData.append('quantity', quantity);
        const response = await fetch(`<%= API_URL %>/api/v1/carts/add`, {
            method: 'POST',
            credentials: 'include',
            body: formData,
        });
        return await response.json();
    }

    document.addEventListener("DOMContentLoaded", () => {
        const addToCartButtons = document.querySelectorAll(".add-to-cart");
        addToCartButtons.forEach(button => {
            button.addEventListener("click", async function () {
                const productId = this.dataset.productId;
                const color = document.getElementById("product-color")?.value || "";
                const size = document.getElementById("product-size")?.value || "";
                const quantity = document.getElementById("product-quantity").value || 1;
                const response = await addToCart_request(productId, color, size, quantity);
                if (response.status === 200) {
                    await createModal(['Votre produit a bien été ajouté au panier!'], "RELOAD");
                } else {
                    await createModal(response.id.codes || ['Erreur lors de l\'ajout au panier'], "ERROR");
                }
            });
        });
    });

    /*********************
     * Gestion de la modification/suppression et report des avis
     *********************/
    document.addEventListener('DOMContentLoaded', () => {
        // Modification d'avis
        document.querySelectorAll('.edit-review').forEach(button => {
            button.addEventListener('click', (e) => {
                const reviewElement = e.target.closest('.review');
                reviewElement.querySelector('.review-content').style.display = 'none';
                reviewElement.querySelector('.review-actions').style.display = 'none';
                const editForm = reviewElement.querySelector('.edit-review-form');
                editForm.style.display = 'block';
                const editStarContainer = editForm.querySelector('.edit-star-rating');
                const editRatingInput = editForm.querySelector('.edit-review-rating');
                setupStarRating(editStarContainer, editRatingInput, parseFloat(editRatingInput.value));
            });
        });
        // Annuler édition
        document.querySelectorAll('.cancel-edit').forEach(button => {
            button.addEventListener('click', (e) => {
                const reviewElement = e.target.closest('.review');
                reviewElement.querySelector('.edit-review-form').style.display = 'none';
                reviewElement.querySelector('.review-content').style.display = 'block';
                reviewElement.querySelector('.review-actions').style.display = 'block';
            });
        });
        // Sauvegarder édition
        document.querySelectorAll('.save-review').forEach(button => {
            button.addEventListener('click', async (e) => {
                const reviewElement = e.target.closest('.review');
                const reviewId = reviewElement.getAttribute('data-review-id');
                const newReview = reviewElement.querySelector('.edit-review-text').value;
                const newRating = reviewElement.querySelector('.edit-review-rating').value;
                const modified = await modifyReview_request(newReview, newRating, reviewId);
                if (modified.status === 200) {
                    reviewElement.querySelector('[data-review-text]').textContent = newReview;
                    reviewElement.querySelector('.edit-review-form').style.display = 'none';
                    reviewElement.querySelector('.review-content').style.display = 'block';
                    reviewElement.querySelector('.review-actions').style.display = 'block';
                    // Mise à jour du star rating en lecture seule
                    const ratingDisplay = reviewElement.querySelector('.review-rating-display');
                    ratingDisplay.setAttribute('data-rating', newRating);
                    ratingDisplay.innerHTML = generateReadonlyStars(parseFloat(newRating));
                } else {
                    await createModal(modified.id.codes || ['Erreur lors de la modification de l\'avis'], "ERROR");
                }
            });
        });
        // Suppression d'avis
        document.querySelectorAll('.delete-review').forEach(async button => {
            await button.addEventListener('click', async (e) => {
                const reviewToDelete = e.target.closest('.review');
                const reviewId = reviewToDelete.getAttribute("data-review-id");
                if (await createModal(["Veuillez confirmer la supression de l'avis"], "CONFIRM")) {
                    const deleted = await deleteReview_request(reviewId);
                    if (deleted.status === 200) {
                        await createModal(['L\'avis a bien été supprimé.'], "RELOAD");
                        reviewToDelete.remove();
                    } else {
                        await createModal(deleted.id.codes || ['Erreur lors de la supression de l\'avis'], "ERROR");
                    }
                }
            });
        });

        // Report d'avis
        document.querySelectorAll('.report-review').forEach(button => {
            button.addEventListener('click', async (e) => {
                const reviewElement = e.target.closest('.review');
                const reviewId = reviewElement.getAttribute('data-review-id');
                const reported = await reportReview_request(reviewId);
                if (reported.status === 200) {
                    button.disabled = true;
                    button.textContent = "Déjà signalé";
                } else {
                    await createModal(reported.id.codes || ['Erreur lors du signalement de l\'avis'], "ERROR");
                }
            });
        });
    });
</script>